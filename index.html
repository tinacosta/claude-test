<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soprano Ornamentation Exercises</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 24px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 13px;
        }

        .exercise-selector {
            margin-bottom: 20px;
        }

        .exercise-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .display-area {
            background: #1a1a2e;
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 200px;
            text-align: center;
        }

        .current-note {
            font-size: 60px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #ffd700;
        }

        .info {
            font-size: 18px;
            color: #87CEEB;
            margin: 10px 0;
        }

        .status {
            font-size: 14px;
            color: #aaa;
            margin-top: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            min-width: 120px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-start {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .btn-pause {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .btn-stop {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .guidance-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .primer-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .guidance-label {
            font-size: 12px;
            font-weight: 700;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .primer-label {
            font-size: 12px;
            font-weight: 700;
            color: #ff9800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .primer-text {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
            font-family: 'Courier New', monospace;
        }

        .syllables {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .technique {
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }

        .tempo-control {
            margin-bottom: 20px;
            text-align: center;
        }

        .tempo-control input {
            width: 100%;
            margin: 10px 0;
        }

        .tempo-value {
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ Soprano Ornamentation Exercises</h1>
        <p class="subtitle">D3 to D6 Range â€¢ 18 Advanced Exercises</p>

        <div class="exercise-selector">
            <select id="exercise-select">
                <option value="scale">Chromatic Scale (C4-D6-D3)</option>
                <option value="ninescale">Nine-Note Scale</option>
                <option value="trill">Baroque Trill - Italian Style</option>
                <option value="portamento">Bel Canto Portamento</option>
                <option value="run">Coloratura Run</option>
                <option value="messa">Messa di Voce with Turn</option>
                <option value="appoggiatura">Appoggiatura Sequence</option>
                <option value="doubleappoggiatura">Double Appoggiatura from Above</option>
                <option value="seannoscut">Sean NÃ³s Cut (Diatonic)</option>
                <option value="jazz">Jazz Scoop and Fall</option>
                <option value="french">French Ornamental Grace Notes</option>
                <option value="mordent">German Lieder Mordent</option>
                <option value="melisma">Spanish Melisma</option>
                <option value="staccato">Staccato Pearls (Perlen)</option>
                <option value="seannos">Sean NÃ³s Irish Ornaments</option>
                <option value="mariah">ðŸŽ¤ Mariah Carey Melismatic Run</option>
                <option value="whitney">ðŸŽ¤ Whitney Houston Gospel Run</option>
                <option value="ariana">ðŸŽ¤ Ariana Grande Contemporary Run</option>
                <option value="rosalia">ðŸŽ¤ RosalÃ­a Flamenco-Pop Run</option>
            </select>
        </div>

        <div class="primer-box">
            <div class="primer-label">Exercise Pattern</div>
            <div class="primer-text" id="primer-text">Chromatic scale: 1, â™¯1/â™­2, 2, â™¯2/â™­3, 3, 4, â™¯4/â™­5, 5, â™¯5/â™­6, 6, â™¯6/â™­7, 7, 8... Ascending by half steps with breath between each step, then descending.</div>
        </div>

        <div class="guidance-box">
            <div class="guidance-label">Syllables to Sing</div>
            <div class="syllables" id="syllables-text">ma, me, mi, mo, mu</div>
            <div class="guidance-label">Technique</div>
            <div class="technique" id="technique-text">Keep throat open and relaxed. Support from the diaphragm. Maintain consistent tone quality throughout the range. Focus on smooth transitions between registers.</div>
        </div>

        <div class="tempo-control">
            <div>Tempo: <span class="tempo-value" id="tempo-value">60 BPM</span></div>
            <input type="range" id="tempo-slider" min="20" max="140" value="60" step="5">
        </div>

        <div class="tempo-control">
            <div>Volume: <span class="tempo-value" id="volume-value">50%</span></div>
            <input type="range" id="volume-slider" min="10" max="100" value="50" step="5">
        </div>

        <div class="display-area">
            <div class="current-note" id="current-note">â€”</div>
            <div class="info" id="info-text">Select exercise and tap Start</div>
            <div class="status" id="status-text">Ready</div>
        </div>

        <div class="controls">
            <button class="btn-start" id="btn-start">Start Exercise</button>
            <button class="btn-pause" id="btn-pause" disabled>Pause</button>
            <button class="btn-stop" id="btn-stop" disabled>Stop</button>
        </div>
    </div>

    <script>
        // Simple Web Audio API implementation for mobile compatibility
        let audioContext = null;
        let isPlaying = false;
        let isPaused = false;
        let currentTimeout = null;
        let tempo = 60; // Will be set to exercise default
        let volume = 50; // Volume percentage (10-100)
        let currentNoteIndex = 0;
        let currentExercise = 'scale';
        let wakeLock = null; // Keep screen awake during exercises

        // Note frequencies
        const notes = {
            'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65,
            'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63,
            'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00,
            'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25,
            'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00,
            'A#5': 932.33, 'B5': 987.77,
            'C6': 1046.50, 'C#6': 1108.73, 'D6': 1174.66
        };

        // Helper to get all notes in chromatic order
        const chromaticNotes = ['C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4',
                                'C5', 'C#5', 'D5', 'D#5', 'E5', 'F5', 'F#5', 'G5', 'G#5', 'A5', 'A#5', 'B5',
                                'C6', 'C#6', 'D6'];
        const descendingNotes = ['C#6', 'C6', 'B5', 'A#5', 'A5', 'G#5', 'G5', 'F#5', 'F5', 'E5', 'D#5', 'D5', 'C#5', 'C5',
                                 'B4', 'A#4', 'A4', 'G#4', 'G4', 'F#4', 'F4', 'E4', 'D#4', 'D4', 'C#4', 'C4',
                                 'B3', 'A#3', 'A3', 'G#3', 'G3', 'F#3', 'F3', 'E3', 'D#3', 'D3'];

        // Helper to transpose a pattern by semitones
        function transposeNote(baseNote, semitones) {
            const allNoteNames = Object.keys(notes);
            const baseIndex = allNoteNames.indexOf(baseNote);
            if (baseIndex === -1) return baseNote;
            const newIndex = baseIndex + semitones;
            if (newIndex >= 0 && newIndex < allNoteNames.length) {
                return allNoteNames[newIndex];
            }
            return baseNote;
        }

        // Check if a pattern starting at a note would exceed max range
        function patternExceedsMax(startNote, pattern, maxNote) {
            const allNoteNames = Object.keys(notes);
            const startIndex = allNoteNames.indexOf(startNote);
            const maxIndex = allNoteNames.indexOf(maxNote);

            for (const interval of pattern) {
                const targetIndex = startIndex + interval;
                // Check if the target index would be out of bounds or exceed max
                if (targetIndex < 0 || targetIndex >= allNoteNames.length || targetIndex > maxIndex) {
                    return true;
                }
            }
            return false;
        }

        // Check if a pattern starting at a note would go below min range
        function patternGoesBelowMin(startNote, pattern, minNote) {
            const allNoteNames = Object.keys(notes);
            const startIndex = allNoteNames.indexOf(startNote);
            const minIndex = allNoteNames.indexOf(minNote);

            for (const interval of pattern) {
                const targetIndex = startIndex + interval;
                // Check if the target index would be out of bounds or below min
                if (targetIndex < 0 || targetIndex >= allNoteNames.length || targetIndex < minIndex) {
                    return true;
                }
            }
            return false;
        }

        // Generate notes for an exercise based on pattern
        function generateExerciseNotes(pattern) {
            const allNotes = [];
            const allNoteNames = Object.keys(notes);
            let highestStartNoteIndex = -1;

            // Ascending - stop when pattern would exceed D6
            for (let i = 0; i < chromaticNotes.length; i++) {
                const startNote = chromaticNotes[i];
                if (patternExceedsMax(startNote, pattern, 'D6')) {
                    break; // Stop ascending when pattern would exceed D6
                }
                highestStartNoteIndex = allNoteNames.indexOf(startNote);
                for (const interval of pattern) {
                    allNotes.push(transposeNote(startNote, interval));
                }
                allNotes.push('BREATH'); // Breathing marker
            }

            // Descending - start from one semitone below where we stopped ascending
            // Only stop when pattern would go below D3 (not when it reaches up to D6)
            if (highestStartNoteIndex >= 0) {
                for (let i = highestStartNoteIndex - 1; i >= 0; i--) {
                    const startNote = allNoteNames[i];
                    if (patternGoesBelowMin(startNote, pattern, 'D3')) {
                        break; // Stop descending when pattern would go below D3
                    }
                    for (const interval of pattern) {
                        allNotes.push(transposeNote(startNote, interval));
                    }
                    allNotes.push('BREATH'); // Breathing marker
                }
            }

            return allNotes;
        }

        // Exercise patterns (defined as interval patterns from root)
        const exercises = {
            scale: {
                name: 'Chromatic Scale',
                pattern: [0, 1, 2, 3, 4], // 5-note chromatic pattern
                duration: 0.4,
                tempo: 60,
                syllables: ['ma', 'me', 'mi', 'mo', 'mu'],
                technique: 'Keep throat open and relaxed. Support from the diaphragm. Maintain consistent tone quality throughout the range. Focus on smooth transitions between registers.',
                primer: 'Chromatic scale: 1, â™¯1, 2, â™¯2, 3. Five-note chromatic pattern starting on each semitone.'
            },
            ninescale: {
                name: 'Nine-Note Scale',
                pattern: [0, 2, 4, 5, 7, 9, 11, 12, 14], // Major scale up a 9th
                duration: 0.35,
                tempo: 60,
                syllables: ['do', 're', 'mi', 'fa', 'sol', 'la', 'ti', 'do', 're'],
                technique: 'Ascending nine-note major scale spanning an octave plus a second. Excellent for range extension and smooth register transitions. Maintain even tone throughout the entire passage.',
                primer: 'Major 9th: 1-2-3-4-5-6-7-8-9 (do-re-mi-fa-sol-la-ti-do-re). Full octave plus one step.'
            },
            trill: {
                name: 'Baroque Trill - Italian Style',
                pattern: [0, 2, 0, 2], // Trill: root, whole step up, root, whole step up
                duration: 0.25,
                tempo: 60,
                syllables: ['i', 'e', 'a'],
                technique: 'Classic upper-neighbor trill. Emphasize clarity and evenness. Keep the throat free and let rapid motion come from the vocal cords.',
                primer: 'Upper-neighbor trill: 1-2-1-2 (do-re-do-re). Repeat this pattern at each semitone.'
            },
            portamento: {
                name: 'Bel Canto Portamento',
                pattern: [0, 4, 7, 12, 7, 4, 0], // Major arpeggio up and down
                duration: 0.5,
                tempo: 60,
                syllables: ['o', 'u', 'a'],
                technique: 'Smooth gliding between notes with connected tone. Focus on seamless legato. Imagine a ribbon of sound connecting each note without breaks.',
                primer: 'Arpeggios with smooth connection: 1-3-5-8-5-3-1 (do-mi-sol-do-sol-mi-do). Major triad at each pitch.'
            },
            run: {
                name: 'Coloratura Run',
                pattern: [0, 2, 4, 5, 7, 5, 4, 2, 0], // Major scale fragment up and down
                duration: 0.18,
                tempo: 60,
                syllables: ['a', 'i'],
                technique: 'Rapid scale passages requiring agility and precision. Keep throat open and relaxed. Each note clear but connected like pearls on a string.',
                primer: 'Fast runs: 1-2-3-4-5-4-3-2-1 (do-re-mi-fa-sol-fa-mi-re-do). Diatonic pattern at each step.'
            },
            messa: {
                name: 'Messa di Voce with Turn',
                pattern: [0, 2, 0, -1, 0], // Turn: root, step up, root, step down, root
                duration: 0.45,
                tempo: 60,
                syllables: ['a', 'e', 'o'],
                technique: 'Crescendo-decrescendo on sustained notes with ornamental turn. Master dynamic control while maintaining steady breath support.',
                primer: 'Turn around main note: 1-2-1-7-1 (do-re-do-ti-do). Add dynamic swell on each pattern.'
            },
            appoggiatura: {
                name: 'Appoggiatura Sequence',
                pattern: [2, 0, 4, 2], // Leaning notes resolving down
                duration: 0.4,
                tempo: 60,
                syllables: ['e', 'o'],
                technique: 'Leaning notes resolving downward. Stress the appoggiatura with a slight accent, then release smoothly to the resolution.',
                primer: 'Leaning note resolution: 2-1, 4-3 (re-do, fa-mi). Dissonance to resolution.'
            },
            doubleappoggiatura: {
                name: 'Double Appoggiatura from Above',
                pattern: [2, 1, 0, 4, 3, 2], // Two ornamental notes resolving down
                duration: 0.35,
                tempo: 60,
                syllables: ['a', 'e', 'o'],
                technique: 'Two ornamental notes from above resolving to the main note. Classical Baroque ornamentation. Let each note cascade gracefully downward with elegant articulation.',
                primer: 'Double ornament descent: 2-â™¯1-1, 3-â™¯2-2 (re-di-do, mi-ri-re). Two-note descent to resolution.'
            },
            seannoscut: {
                name: 'Sean NÃ³s Cut (Diatonic)',
                pattern: [4, 2, 0], // Long cut: diatonic triplet down
                duration: 0.2,
                tempo: 60,
                syllables: ['a', 'o'],
                technique: 'Irish traditional "long cut" ornament. Three notes descending diatonically in a quick, natural triplet. Keep it light and speech-like, not mechanical. This is pure sean nÃ³s style.',
                primer: 'Long cut: 3-2-1 (mi-re-do). Diatonic triplet ornament descending to main note.'
            },
            jazz: {
                name: 'Jazz Scoop and Fall',
                pattern: [0, 4, 7, 4, 0], // Arpeggio with scoop
                duration: 0.45,
                tempo: 60,
                syllables: ['a', 'oh', 'yeah'],
                technique: 'Slide into and out of notes with style. Use vibrato at the peak. Channel the freedom and expressiveness of jazz phrasing.',
                primer: 'Scoop to chord tones: 1-3-5-3-1 (do-mi-sol-mi-do) with glides.'
            },
            french: {
                name: 'French Ornamental Grace Notes',
                pattern: [-1, 0, 1, 2], // Grace note approach
                duration: 0.3,
                tempo: 60,
                syllables: ['i', 'u'],
                technique: 'Delicate grace notes before main tones. Light and articulate, like Couperin. Quick and elegant with refined articulation.',
                primer: 'Grace note before main note: 7-1-2-3 (ti-do-re-mi). Quick ornamental approach.'
            },
            mordent: {
                name: 'German Lieder Mordent',
                pattern: [0, -1, 0], // Lower neighbor mordent
                duration: 0.3,
                tempo: 60,
                syllables: ['Ã¤', 'Ã¶', 'a'],
                technique: 'Quick alternation with lower neighbor. Expressive and speech-like. Channel the emotional depth of German Romantic song.',
                primer: 'Lower-neighbor mordent: 1-7-1 (do-ti-do). Main note with quick dip below.'
            },
            melisma: {
                name: 'Spanish Melisma',
                pattern: [0, 2, 4, 7, 9, 7, 4, 0], // Flowing scale fragment
                duration: 0.25,
                tempo: 60,
                syllables: ['a', 'ay', 'e'],
                technique: 'Flowing melismatic passages with passion. Channel flamenco ornamentation. Let the notes cascade with energy and expression.',
                primer: 'Flowing scale fragments: 1-2-3-5-6-5-3-1 (do-re-mi-sol-la-sol-mi-do). Cascading patterns.'
            },
            staccato: {
                name: 'Staccato Pearls (Perlen)',
                pattern: [0, 4, 7, 12], // Staccato arpeggio
                duration: 0.18,
                tempo: 60,
                syllables: ['a', 'i'],
                technique: 'Brilliant staccato notes like pearls on a string. Light, precise, and dazzling. Think Queen of the Night - each note sparkles individually.',
                primer: 'Staccato arpeggios: 1-3-5-8 (do-mi-sol-do). Brilliant articulation ascending.'
            },
            mariah: {
                name: 'Mariah Carey Melismatic Run',
                pattern: [0, 1, 2, 4, 5, 7, 9, 7, 5, 4, 2, 1, 0], // Chromatic start to full octave
                duration: 0.12,
                tempo: 60,
                syllables: ['a', 'e', 'i', 'oh'],
                technique: 'Ultra-fast melismatic passages mixing chromatic and diatonic notes. Focus on throat relaxation and whistle-register readiness. Let the notes flow like water with effortless agility.',
                primer: 'Melismatic cascade: 1-â™¯1-2-3-4-5-6-5-4-3-2-â™¯1-1. Fast chromatic-to-diatonic runs with decorative flourishes.'
            },
            whitney: {
                name: 'Whitney Houston Gospel Run',
                pattern: [0, 2, 3, 5, 7, 10, 7, 5, 3, 2, 0], // Pentatonic-influenced gospel run
                duration: 0.15,
                tempo: 60,
                syllables: ['oh', 'yeah', 'a', 'e'],
                technique: 'Soulful gospel runs with emotional depth. Add slight scoops and falls for authenticity. Let the spirit move through each note with power and passion.',
                primer: 'Gospel pentatonic: 1-2-â™­3-4-5-â™­7-5-4-â™­3-2-1. Pentatonic-based runs with soul and power.'
            },
            ariana: {
                name: 'Ariana Grande Contemporary Run',
                pattern: [0, 2, 4, 5, 7, 9, 11, 12, 11, 9, 7, 5, 4, 2, 0], // Full octave scalar with chromatic touches
                duration: 0.11,
                tempo: 60,
                syllables: ['a', 'e', 'i'],
                technique: 'Modern pop runs with precision and speed. Light, airy tone with crisp articulation. Emphasis on agility while maintaining breathiness in the upper register.',
                primer: 'Contemporary cascade: 1-2-3-4-5-6-7-8-7-6-5-4-3-2-1. Full octave runs with modern pop styling.'
            },
            seannos: {
                name: 'Sean NÃ³s Irish Ornaments',
                pattern: [0, 1, 0, -1, 0, 2, 0], // Crann (triplet) and grace note ornaments
                duration: 0.22,
                tempo: 60,
                syllables: ['a', 'o', 'i'],
                technique: 'Irish traditional ornaments with slides and grace notes. Keep the ornamentation natural and speech-like. Let each ornament flow freely without strict rhythm - this is the heart of sean nÃ³s.',
                primer: 'Irish crann ornament: 1-â™¯1-1-7-1-2-1 (do-di-do-ti-do-re-do). Free-flowing grace notes and slides.'
            },
            rosalia: {
                name: 'RosalÃ­a Flamenco-Pop Run',
                pattern: [0, 1, 3, 5, 6, 8, 10, 8, 6, 5, 3, 1, 0], // Phrygian-influenced with chromatic touches
                duration: 0.13,
                tempo: 60,
                syllables: ['a', 'e', 'ay', 'oh'],
                technique: 'Contemporary flamenco fusion with dramatic flair. Mix traditional Spanish ornamentation with modern pop precision. Add vibrato and slight pitch bends for authentic RosalÃ­a style.',
                primer: 'Flamenco-pop cascade: 1-â™­2-â™­3-4-â™­5-â™­6-â™­7-â™­6-â™­5-4-â™­3-â™­2-1. Phrygian mode with fire and passion.'
            }
        };

        // Initialize audio context on user interaction
        async function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // Resume if suspended (iOS requirement)
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            return audioContext.state === 'running';
        }

        // Request wake lock to keep screen awake
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                // Wake lock request failed - not critical, just continue
                console.log('Wake lock error:', err);
            }
        }

        // Release wake lock
        async function releaseWakeLock() {
            if (wakeLock !== null) {
                try {
                    await wakeLock.release();
                    wakeLock = null;
                } catch (err) {
                    console.log('Wake lock release error:', err);
                }
            }
        }

        // Play a single note
        function playTone(frequency, duration) {
            if (!audioContext || audioContext.state !== 'running') {
                return duration * 1000;
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            const now = audioContext.currentTime;
            const noteDuration = duration * (60 / tempo);

            // Simple envelope with volume control
            const volumeScale = volume / 100;
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.5 * volumeScale, now + 0.02);
            gainNode.gain.linearRampToValueAtTime(0.4 * volumeScale, now + noteDuration - 0.05);
            gainNode.gain.linearRampToValueAtTime(0, now + noteDuration);

            oscillator.start(now);
            oscillator.stop(now + noteDuration);

            return noteDuration * 1000;
        }

        // Play next note in sequence
        function playNextNote() {
            if (!isPlaying || isPaused) return;

            const exercise = exercises[currentExercise];

            if (currentNoteIndex >= exercise.notes.length) {
                stopExercise();
                updateStatus('Exercise complete!');
                updateNote('âœ“');
                updateInfo('Well done!');
                return;
            }

            const noteName = exercise.notes[currentNoteIndex];

            // Check for breathing marker
            if (noteName === 'BREATH') {
                updateStatus('Breathe...');
                currentNoteIndex++;
                currentTimeout = setTimeout(() => {
                    playNextNote();
                }, 800); // 800ms breathing pause
                return;
            }

            const frequency = notes[noteName];

            updateNote(noteName);
            updateInfo(`Note ${currentNoteIndex + 1} of ${exercise.notes.length}`);
            updateStatus('Playing...');

            const duration = playTone(frequency, exercise.duration);

            currentNoteIndex++;

            currentTimeout = setTimeout(() => {
                playNextNote();
            }, duration);
        }

        // Start exercise
        async function startExercise() {
            await initAudio();
            await requestWakeLock(); // Keep screen awake

            if (isPaused) {
                isPaused = false;
                isPlaying = true;
                updateButtons();
                playNextNote();
                return;
            }

            isPlaying = true;
            isPaused = false;
            currentNoteIndex = 0;

            const exercise = exercises[currentExercise];

            // Generate notes from pattern
            exercise.notes = generateExerciseNotes(exercise.pattern);

            updateInfo(`${exercise.name}`);
            updateStatus('Playing...');

            updateButtons();
            playNextNote();
        }

        // Pause exercise
        function pauseExercise() {
            isPaused = true;
            isPlaying = false;
            if (currentTimeout) clearTimeout(currentTimeout);
            releaseWakeLock(); // Allow screen to sleep
            updateStatus('Paused');
            updateButtons();
        }

        // Stop exercise
        function stopExercise() {
            isPlaying = false;
            isPaused = false;
            if (currentTimeout) clearTimeout(currentTimeout);
            currentNoteIndex = 0;
            releaseWakeLock(); // Allow screen to sleep
            updateNote('â€”');
            updateStatus('Stopped');
            updateInfo('Select exercise and tap Start');
            updateButtons();
        }

        // Update UI
        function updateNote(note) {
            document.getElementById('current-note').textContent = note;
        }

        function updateInfo(text) {
            document.getElementById('info-text').textContent = text;
        }

        function updateStatus(text) {
            document.getElementById('status-text').textContent = text;
        }

        function updateButtons() {
            document.getElementById('btn-start').disabled = isPlaying;
            document.getElementById('btn-pause').disabled = !isPlaying;
            document.getElementById('btn-stop').disabled = !isPlaying && !isPaused;
        }

        function updateGuidance() {
            const exercise = exercises[currentExercise];
            document.getElementById('syllables-text').textContent = exercise.syllables.join(', ');
            document.getElementById('technique-text').textContent = exercise.technique;
        }

        function updatePrimer() {
            const exercise = exercises[currentExercise];
            document.getElementById('primer-text').textContent = exercise.primer;
        }

        // Event listeners
        document.getElementById('btn-start').addEventListener('click', startExercise);
        document.getElementById('btn-pause').addEventListener('click', pauseExercise);
        document.getElementById('btn-stop').addEventListener('click', stopExercise);

        document.getElementById('exercise-select').addEventListener('change', (e) => {
            currentExercise = e.target.value;
            stopExercise();
            const exercise = exercises[currentExercise];

            // Update tempo to exercise's default
            tempo = exercise.tempo;
            document.getElementById('tempo-slider').value = tempo;
            document.getElementById('tempo-value').textContent = tempo + ' BPM';

            updateInfo(`Selected: ${exercise.name}`);
            updateGuidance();
            updatePrimer();
        });

        document.getElementById('tempo-slider').addEventListener('input', (e) => {
            tempo = parseInt(e.target.value);
            document.getElementById('tempo-value').textContent = tempo + ' BPM';
        });

        document.getElementById('volume-slider').addEventListener('input', (e) => {
            volume = parseInt(e.target.value);
            document.getElementById('volume-value').textContent = volume + '%';
        });

        // Initialize
        tempo = exercises[currentExercise].tempo;
        document.getElementById('tempo-slider').value = tempo;
        document.getElementById('tempo-value').textContent = tempo + ' BPM';
        updateButtons();
        updateGuidance();
        updatePrimer();
    </script>
</body>
</html>
